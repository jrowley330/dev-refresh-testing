<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Digital Dispo Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --brand: #007bff;
      --overlay: rgba(0,0,0,0.6);
      --card: #111;
      --text: #fff;
      --bar: #00bcd4;
      --bg: #f9f9f9;
    }
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .viewport { position: relative; height: 100vh; width: 100%; overflow: hidden; }
    iframe { border: none; width: 100%; height: 100%; display: block; }

    /* Floating refresh button */
    .refresh-btn {
      position: fixed; right: 20px; bottom: 20px;
      background: var(--brand); color: #fff; border: none; border-radius: 999px;
      padding: 14px 18px; font-size: 16px; cursor: pointer;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      display: inline-flex; align-items: center; gap: 10px; z-index: 1000;
    }
    .refresh-btn:disabled { opacity: .6; cursor: not-allowed; }
    .refresh-icon { width: 18px; height: 18px; display: inline-block; transform-origin: center; }

    /* Overlay + progress card */
    .overlay {
      position: fixed; inset: 0; background: var(--overlay);
      display: none; align-items: center; justify-content: center; z-index: 999;
    }
    .overlay.active { display: flex; }
    .card {
      width: min(520px, 92vw); background: var(--card); color: var(--text);
      border-radius: 14px; padding: 24px; box-shadow: 0 12px 40px rgba(0,0,0,0.35); text-align: center;
    }
    .card h2 { margin: 0 0 8px; font-size: 20px; font-weight: 600; }
    .card p { margin: 4px 0 16px; color: #d7d7d7; font-size: 14px; }

    .progress-wrap { width: 100%; background: #222; border-radius: 10px; overflow: hidden; height: 12px; }
    .progress-bar { width: 0%; height: 100%; background: var(--bar); transition: width 0.25s linear; }
    .eta { margin-top: 10px; font-size: 13px; color: #cfcfcf; letter-spacing: 0.3px; }

    .no-pointer { pointer-events: none; } /* block iframe clicks while overlay shown */
  </style>
</head>
<body>
  <div class="viewport">
    <iframe id="pbi-frame"
      title="Digital Dispo Dashboards v3 - Dev - Refresh Enhancements"
      src="https://app.powerbi.com/reportEmbed?reportId=8160e2db-de87-4526-8b8e-c488f10d8b89&autoAuth=true&ctid=d1c56a60-dcf2-4ba0-8d19-e41646e6ead8&navContentPaneEnabled=false&filterPaneEnabled=false">
    </iframe>
  </div>

  <!-- Floating Refresh Button -->
  <button id="refreshBtn" class="refresh-btn" title="Refresh data">
    <svg class="refresh-icon" viewBox="0 0 24 24" aria-hidden="true">
      <path fill="currentColor"
        d="M17.65 6.35A7.95 7.95 0 0 0 12 4a8 8 0 1 0 7.75 10h-2.1A6 6 0 1 1 12 6c1.66 0 3.14.67 4.22 1.76L14 10h6V4l-2.35 2.35z"/>
    </svg>
    Refresh data
  </button>

  <!-- Overlay + Progress -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="card">
      <h2>Refreshing your report…</h2>
      <p>We’re kicking off the dataset refresh and reloading the report when it’s ready.</p>
      <div class="progress-wrap"><div id="progressBar" class="progress-bar"></div></div>
      <div id="eta" class="eta">~30s remaining</div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const MAKE_WEBHOOK_URL   = 'https://hook.us2.make.com/0000123'; // your Make webhook (UPDATE)
    const REFRESH_DURATION_MS = 30000; // 30 seconds
    // ====================

    const refreshBtn  = document.getElementById('refreshBtn');
    const overlay     = document.getElementById('overlay');
    const progressBar = document.getElementById('progressBar');
    const etaEl       = document.getElementById('eta');
    const frame       = document.getElementById('pbi-frame');

    function showOverlay() {
      overlay.classList.add('active');
      overlay.setAttribute('aria-hidden', 'false');
      frame.classList.add('no-pointer');
    }
    function hideOverlay() {
      overlay.classList.remove('active');
      overlay.setAttribute('aria-hidden', 'true');
      frame.classList.remove('no-pointer');
    }

    function animateProgress(durationMs) {
      progressBar.style.width = '0%';
      const start = performance.now();
      return new Promise((resolve) => {
        const tick = (now) => {
          const elapsed = now - start;
          const pct = Math.min(100, (elapsed / durationMs) * 100);
          progressBar.style.width = pct.toFixed(2) + '%';
          const remaining = Math.max(0, Math.ceil((durationMs - elapsed) / 1000));
          etaEl.textContent = `~${remaining}s remaining`;
          if (elapsed >= durationMs) resolve();
          else requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
      });
    }

    function triggerMakeWebhook() {
      try {
        fetch(MAKE_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source: 'digital-dispo-report', action: 'refresh_request', ts: Date.now() })
        }).catch(() => {});
      } catch (_) {}
    }

    function reloadIframeWithCacheBuster() {
      const url = new URL(frame.src);
      url.searchParams.set('_ts', Date.now().toString_
